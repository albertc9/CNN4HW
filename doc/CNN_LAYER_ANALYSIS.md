# CNN模型各层输入输出分析报告

## 模型概览

- **模型文件**: `models/10.07.25_15-31_100s_2D_CNN_model_2Layer.h5`
- **数据文件**: `data/filtered_coinc.pkl`
- **总参数量**: 5,211
- **层数**: 5层

---

## 数据流向

```
输入 (1, 4, 256, 1)
  ↓
Conv2D Layer 0 (1, 1, 247, 20)
  ↓
Conv2D Layer 1 (1, 1, 238, 10)
  ↓
Dropout Layer 2 (1, 1, 238, 10)
  ↓
Flatten Layer 3 (1, 2380)
  ↓
Dense Layer 4 (1, 1)
```

---

## 第0层: Conv2D (conv2d)

### 配置
- **卷积核数量**: 20个滤波器
- **卷积核大小**: (4, 10)
- **激活函数**: ReLU

### 输入数据
- **形状**: (1, 4, 256, 1)
  - 批次大小: 1
  - 通道数: 4 (对应4个探测器通道)
  - 时间采样点: 256
  - 特征维度: 1
- **数值范围**: [-0.0923, 0.1146]
- **均值**: 0.000103
- **标准差**: 0.0247

### 参数 (Weights)

#### 卷积核 (Kernel)
- **形状**: (4, 10, 1, 20)
- **总参数数**: 800
- **数值范围**: [-0.646, 0.619]
- **均值**: -0.00512
- **标准差**: 0.164

#### 偏置 (Bias)
- **形状**: (20,)
- **总参数数**: 20
- **数值范围**: [-0.151, 0.098]
- **均值**: -0.0151
- **标准差**: 0.0458

### 输出数据
- **形状**: (1, 1, 247, 20)
  - 247个时间位置
  - 20个特征图
- **数值范围**: [0.0, 0.183] (ReLU激活后)
- **均值**: 0.0106
- **标准差**: 0.0247

---

## 第1层: Conv2D (conv2d_1)

### 配置
- **卷积核数量**: 10个滤波器
- **卷积核大小**: (1, 10)
- **激活函数**: ReLU

### 参数 (Weights)

#### 卷积核 (Kernel)
- **形状**: (1, 10, 20, 10)
- **总参数数**: 2,000
- **数值范围**: [-0.537, 0.616]
- **均值**: 0.0215
- **标准差**: 0.174

#### 偏置 (Bias)
- **形状**: (10,)
- **总参数数**: 10
- **数值范围**: [-0.113, 0.118]
- **均值**: -0.0126
- **标准差**: 0.0592

### 输出数据
- **形状**: (1, 1, 238, 10)
  - 238个时间位置
  - 10个特征图
- **数值范围**: [0.0, 0.308]
- **均值**: 0.0336
- **标准差**: 0.0723

---

## 第2层: Dropout (dropout)

### 配置
- **丢弃率**: 0.5 (训练时使用，推理时不起作用)

### 输出数据
- **形状**: (1, 1, 238, 10)
- **数值范围**: [0.0, 0.308]
- **均值**: 0.0336
- **标准差**: 0.0723

*注：推理时Dropout层不改变数据，只在训练时随机丢弃50%的神经元*

---

## 第3层: Flatten (flatten)

### 功能
将3D特征图展平为1D向量

### 输出数据
- **形状**: (1, 2380)
  - 从 (1, 1, 238, 10) → (1, 2380)
  - 2380 = 1 × 238 × 10
- **数值范围**: [0.0, 0.308]
- **均值**: 0.0336
- **标准差**: 0.0723

---

## 第4层: Dense (dense) - 输出层

### 配置
- **神经元数量**: 1 (二分类输出)
- **激活函数**: Sigmoid

### 参数 (Weights)

#### 权重矩阵 (Kernel)
- **形状**: (2380, 1)
- **总参数数**: 2,380
- **数值范围**: [-0.660, 0.561]
- **均值**: 0.0264
- **标准差**: 0.152

#### 偏置 (Bias)
- **形状**: (1,)
- **总参数数**: 1
- **数值**: -0.0298

### 输出数据
- **形状**: (1, 1)
- **数值**: 0.9999996 ≈ 1.0
- **解释**:
  - 接近1表示模型预测为正类（概率约100%）
  - 接近0表示模型预测为负类

---

## 关键发现

### 1. 输入数据特征
- 输入是4通道×256采样点的波形数据
- 数据已经过滤波处理（Filtered_Traces）
- 数值范围较小，已归一化

### 2. 特征提取流程
- **第一层卷积**: 使用4×10卷积核，提取时域和空域特征，输出20个特征图
- **第二层卷积**: 使用1×10卷积核，进一步提取时域特征，压缩到10个特征图
- **Dropout**: 防止过拟合
- **全连接层**: 2380个特征映射到单个输出

### 3. 参数分布
- Conv2D层使用Glorot初始化，权重分布接近零均值
- 大部分激活值经过ReLU后为正值
- 最终输出接近1，表示模型对该样本的高置信度预测

### 4. 数据维度变化
```
(1, 4, 256, 1)    # 输入: 4通道, 256时间点
    ↓ Conv2D (4×10 kernel, 20 filters)
(1, 1, 247, 20)   # 高度从4→1, 宽度256→247, 通道1→20
    ↓ Conv2D (1×10 kernel, 10 filters)
(1, 1, 238, 10)   # 宽度247→238, 通道20→10
    ↓ Flatten
(1, 2380)         # 展平为向量
    ↓ Dense (sigmoid)
(1, 1)            # 二分类输出
```

---

## 如何使用提取的数据

### Python读取示例

```python
import numpy as np
import json

# 读取JSON报告
with open('layer_data_report.json', 'r') as f:
    layer_info = json.load(f)

# 读取numpy数组
data = np.load('layer_data_arrays.npz')

# 可用的数组:
# - data['input']: 输入数据
# - data['conv2d_output']: 第1层卷积输出
# - data['conv2d_1_output']: 第2层卷积输出
# - data['dropout_output']: Dropout层输出
# - data['flatten_output']: Flatten层输出
# - data['dense_output']: 最终输出
# - data['conv2d_kernel']: 第1层卷积核
# - data['conv2d_bias']: 第1层偏置
# - data['conv2d_1_kernel']: 第2层卷积核
# - data['conv2d_1_bias']: 第2层偏置
# - data['dense_kernel']: 全连接层权重
# - data['dense_bias']: 全连接层偏置

# 示例: 查看第一层卷积核的形状
print("Conv2D kernel shape:", data['conv2d_kernel'].shape)
print("Conv2D output shape:", data['conv2d_output'].shape)
```

---

## 与HLS4ML的关系

您选中的 `ap_fixed<18,10>` 是用于FPGA实现时的定点数格式：
- 总位宽: 18位
- 整数位: 10位
- 小数位: 7位 (18-10-1符号位)

根据各层的数值范围，建议的定点数配置：

| 层 | 最大绝对值 | 建议格式 | 说明 |
|----|-----------|---------|------|
| 输入 | 0.115 | `ap_fixed<16,6>` | 留足够的小数精度 |
| Conv2D权重 | 0.646 | `ap_fixed<16,6>` | |
| Conv2D输出 | 0.183 | `ap_fixed<16,6>` | |
| Conv2D_1权重 | 0.616 | `ap_fixed<16,6>` | |
| Conv2D_1输出 | 0.308 | `ap_fixed<16,6>` | |
| Dense权重 | 0.660 | `ap_fixed<16,6>` | |
| Dense输出 | 1.0 | `ap_fixed<18,10>` | Sigmoid输出范围[0,1] |

---

生成时间: 2025-10-09
