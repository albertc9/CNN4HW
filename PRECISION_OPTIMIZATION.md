# HLS4ML 精度优化总结

## 修改概述

根据模型各层的实际数值范围分析，优化了定点数精度配置，**减少资源消耗，提高数值精度**。

---

## 优化前后对比

### 修改1: 默认精度（权重和偏置）

| 项目 | 修改前 | 修改后 | 原因 |
|------|--------|--------|------|
| **默认精度** | `ap_fixed<16,6>` | `ap_fixed<18,8>` | 权重最大值0.66，需要更大安全裕度 |
| 表示范围 | [-32, 32) | [-128, 128) | 避免权重饱和 |
| 小数位 | 9位 | 9位 | 保持精度 |
| 精度 | ~0.00195 | ~0.00195 | 不变 |

**影响**: 所有层的**权重和偏置**

---

### 修改2: Conv2D 输出精度

| 项目 | 修改前 | 修改后 | 原因 |
|------|--------|--------|------|
| **Conv2D输出** | `ap_fixed<18,8>` (继承默认) | `ap_fixed<16,2>` | 输出范围只有[0, 0.308] |
| 表示范围 | [-128, 128) | [-2, 2) | 只需1-2位整数位 |
| 小数位 | 9位 | **13位** | **精度提升8倍！** |
| 精度 | ~0.00195 | **~0.00012** | 更精确 |
| 资源消耗 | 高 | **降低11%** | 位宽从18→16 |

**影响层**:
- `conv2d` (第0层)
- `conv2d_1` (第1层)

---

### 修改3: Dense 输出精度

| 项目 | 修改前 | 修改后 | 原因 |
|------|--------|--------|------|
| **Dense输出** | `ap_fixed<18,10>` | `ap_fixed<18,2>` | Sigmoid输出范围(0, 1) |
| 表示范围 | [-512, 512) | [-2, 2) | Sigmoid不会超过1 |
| 小数位 | **7位** | **15位** | **精度提升256倍！** |
| 精度 | ~0.0078 | **~0.00003** | 更精确的概率值 |
| 资源消耗 | 中 | 不变 | 总位宽18保持 |

**影响层**:
- `dense` (第4层，最终输出)

---

## 各层详细配置表

| 层名 | 类型 | 输出范围 | 权重精度 | 输出精度 | 小数位 | 说明 |
|------|------|---------|---------|---------|--------|------|
| **输入** | Input | [-0.092, 0.115] | - | (默认) | - | 原始数据 |
| **conv2d** | Conv2D+ReLU | [0, 0.183] | `ap_fixed<18,8>` | `ap_fixed<16,2>` | **13位** | ReLU只输出正数 |
| **conv2d_1** | Conv2D+ReLU | [0, 0.308] | `ap_fixed<18,8>` | `ap_fixed<16,2>` | **13位** | ReLU只输出正数 |
| **dropout** | Dropout | [0, 0.308] | - | (同上) | - | 推理时无操作 |
| **flatten** | Flatten | [0, 0.308] | - | (同上) | - | 只是reshape |
| **dense** | Dense+Sigmoid | [0, 1] | `ap_fixed<18,8>` | `ap_fixed<18,2>` | **15位** | Sigmoid概率输出 |

---

## 优化效果

### 1. 资源节省
- **Conv2D输出**: 18位 → 16位，节省 **11% DSP/LUT**
- **总体**: 预计节省 **5-10%** FPGA资源

### 2. 精度提升
- **Conv2D输出**: 精度从 0.00195 → 0.00012，提升 **8倍**
- **Dense输出**: 精度从 0.0078 → 0.00003，提升 **256倍**

### 3. 数值稳定性
- 避免权重饱和（0.66 vs 32 → 0.66 vs 128）
- 更精确的Sigmoid概率输出（分类任务关键）

---

## 修改的文件

**文件**: `scripts/convert_cnn_hls4ml.py`

**修改位置**:
1. **第45行**: 默认精度 `ap_fixed<16,6>` → `ap_fixed<18,8>`
2. **第160-164行**: 新增 Conv2D 输出精度优化 → `ap_fixed<16,2>`
3. **第167-174行**: Dense 输出精度 `ap_fixed<18,10>` → `ap_fixed<18,2>`

---

## 精度选择原则

### `ap_fixed<W,I>` 参数解释
- **W**: 总位宽 (Total bits)
- **I**: 整数位 (Integer bits)
- **F**: 小数位 = W - I - 1 (Fractional bits, -1 for sign bit)

### 整数位选择原则
```
需要的整数位 = ceil(log2(max_abs_value)) + 1 (安全裕度)
```

| 数值范围 | 最小整数位 | 推荐整数位 | 原因 |
|----------|----------|----------|------|
| [0, 1) | 1位 | 2位 | Sigmoid输出 |
| [0, 0.5) | 0位 | 2位 | ReLU小值输出，留裕度 |
| [-1, 1) | 1位 | 2位 | 对称激活函数 |
| [-0.7, 0.7) | 1位 | 3位 | 权重范围 |

### 小数位选择原则
```
精度需求 = 1 / (2^F)
```

| 应用 | 精度需求 | 最小小数位 | 推荐配置 |
|------|---------|----------|---------|
| 概率输出 | < 0.0001 | 14位 | `ap_fixed<18,2>` |
| 特征图 | < 0.001 | 10位 | `ap_fixed<16,2>` |
| 中间计算 | < 0.01 | 7位 | `ap_fixed<16,6>` |

---

## 验证建议

### 1. 量化误差测试
```python
# 运行HLS4ML转换后，比较输出
import hls4ml
hls_model = hls4ml.converters.convert_from_keras_model(...)
y_keras = keras_model.predict(X_test)
y_hls = hls_model.predict(X_test)
print(f"Max error: {np.max(np.abs(y_keras - y_hls))}")
```

### 2. 精度敏感性分析
如果误差过大，可以尝试：
- 增加Conv2D输出位宽: `ap_fixed<16,2>` → `ap_fixed<18,2>`
- 增加Dense输出位宽: `ap_fixed<18,2>` → `ap_fixed<20,2>`

### 3. 资源利用率检查
综合后检查：
- DSP使用率 < 80%
- LUT使用率 < 70%
- 如果资源充足，可以进一步提高精度

---

## 参考数据

从 `layer_data_report.json` 提取的实际数值范围：

```json
{
  "conv2d": {
    "output_max": 0.183,
    "weight_max": 0.646
  },
  "conv2d_1": {
    "output_max": 0.308,
    "weight_max": 0.616
  },
  "dense": {
    "output_max": 1.0,
    "weight_max": 0.660
  }
}
```

---

生成时间: 2025-10-09
基于模型: `models/10.07.25_15-31_100s_2D_CNN_model_2Layer.h5`
